Version 1
SubGoalCombiner SGC_AND
INITSECTION
// One custom perform of The Weeping Dawn, would love to add more but not many sound events that can be re-used
DB_SpecialPerformance_EmbersLute("Bard_Perform_WeepingDawn","SE_DEN_TieflingBard_Bard","SE_DEN_TieflingBard_Bard_Stop","EMLUTE_PERFORM_WEEPINGDAWN",169500);

// Move the tiefling spirit a little bit away from the player when she spawns in
DB_RepositionSummon_EmbersLute((CHARACTERROOT)Emlute_TieflingBard_Spirit_43d08735-7bb2-48a4-a446-b8814d4409c6,1.5,0.0,0.0);

// Found a weird issue with Countercharms in Patch7: they play silent music when they are summoned in.
// My theory is something to do with trying to start a main performer event before the character spawning is complete?
// Issue seems to affect vanilla Countercharm as well as my custom variant, though I'm going to leave vanilla alone since
// my "fix" is horrible (basically adds a delay before applying the aura status with music performance).
DB_CountercharmFix_EmbersLute((CHARACTERROOT)EMLUTE_Countercharm_MusicalSprite_Drum_ed79a011-50f7-4ce1-be1e-c91d6b5f61e6,"EmbersLuteCountercharmDrum",2000,"EMLUTE_COUNTERCHARM_MUSIC");
DB_CountercharmFix_EmbersLute((CHARACTERROOT)EMLUTE_Countercharm_MusicalSprite_Lyre_f0f9422a-41cf-46bb-9ade-af9aa92fa652,"EmbersLuteCountercharmFlute",2500,"EMLUTE_COUNTERCHARM_MUSIC");
DB_CountercharmFix_EmbersLute((CHARACTERROOT)EMLUTE_Countercharm_MusicalSprite_Violin_913c7b82-cd4c-4bd4-b354-69fde9692684,"EmbersLuteCountercharmMusicBox",2600,"EMLUTE_COUNTERCHARM_MUSIC");
KBSECTION
PROC
PROC_RepositionSummon_EmbersLute((CHARACTER)_Summon,(REAL)_OffsetX,(REAL)_OffsetY,(REAL)_OffsetZ)
AND
GetPosition(_Summon,_X,_Y,_Z)
AND
RealSum(_X,_OffsetX,_NewX)
AND
RealSum(_Y,_OffsetY,_NewY)
AND
RealSum(_Z,_OffsetZ,_NewZ)
THEN
PROC_TeleportToSafePosition(_Summon,_NewX,_NewY,_NewZ);
DebugText(_Summon, "Debug: Repositioned the Bard");

PROC
PROC_StartSpecialPerformance_EmbersLute((CHARACTER)_Performer,(STRING)_Song,(STRING)_StartEvent,(INTEGER)_Duration)
AND
NOT DB_ActiveSpecialPerformance_EmbersLute(_Performer,_Song)
THEN
DB_ActiveSpecialPerformance_EmbersLute(_Performer,_Song);
DebugText(_Performer, "Debug: Playing Music");
DebugText(_Performer, _StartEvent);
MusicPlayOnCharacter(_Performer,_StartEvent);
ObjectTimerCancel(_Performer,_Song);
ObjectTimerLaunch(_Performer,_Song,_Duration);

PROC
PROC_StopSpecialPerformance_EmbersLute((CHARACTER)_Performer,(STRING)_Song,(STRING)_StopEvent)
AND
DB_ActiveSpecialPerformance_EmbersLute(_Performer,_Song)
THEN
NOT DB_ActiveSpecialPerformance_EmbersLute(_Performer,_Song);
MusicPlayOnCharacter(_Performer,_StopEvent);

IF
MainPerformerStarted((CHARACTER)_Performer,(STRING)_Song)
AND
DB_SpecialPerformance_EmbersLute(_Song,_StartEvent,_,_,_Duration)
THEN
DebugText(_Performer, "Debug: Starting Performance");
DebugText(_Performer, _Song);
PROC_StartSpecialPerformance_EmbersLute(_Performer,_Song,_StartEvent,_Duration);

IF
StatusRemoved((CHARACTER)_Performer,_Status,_,_)
AND
DB_ActiveSpecialPerformance_EmbersLute(_Performer,_Song)
AND
DB_SpecialPerformance_EmbersLute(_Song,_,_StopEvent,_Status,_)
THEN
ObjectTimerCancel(_Performer,_Song);
PROC_StopSpecialPerformance_EmbersLute(_Performer,_Song,_StopEvent);

IF
ObjectTimerFinished((CHARACTER)_Performer,_TimerName)
AND
DB_ActiveSpecialPerformance_EmbersLute(_Performer,_TimerName)
AND
DB_SpecialPerformance_EmbersLute(_TimerName,_,_,_Status,_)
THEN
RemoveStatus(_Performer,_Status);

IF
EnteredLevel((CHARACTER)_Summon,(CHARACTERROOT)_Template, _)
AND
DB_RepositionSummon_EmbersLute(_Template,_OffsetX,_OffsetY,_OffsetZ)
THEN
PROC_RepositionSummon_EmbersLute(_Summon,_OffsetX,_OffsetY,_OffsetZ);


IF
EnteredLevel((CHARACTER)_Summon,(CHARACTERROOT)_Template, _)
AND
DB_CountercharmFix_EmbersLute(_Template,_TimerName,_Duration,_)
THEN
DebugText(_Summon, "Debug: Starting timer");
ObjectTimerCancel(_Summon,_TimerName);
ObjectTimerLaunch(_Summon,_TimerName,_Duration);

IF
ObjectTimerFinished((CHARACTER)_Summon,_TimerName)
AND
DB_CountercharmFix_EmbersLute(_,_TimerName,_,_Status)
THEN
ApplyStatus(_Summon,_Status,-1.0);

EXITSECTION

ENDEXITSECTION
